name: Update Eureka Components
description: Resolve newer component versions from GitHub releases (respecting scope/order) when Docker images exist.

inputs:
  components:
    description: JSON array of component objects, e.g. [{"name":"folio-kong","version":"3.9.1"}]
    required: true
  filter-scope:
    description: SemVer scope to consider (major|minor|patch)
    required: false
    default: patch
    type: choice
    options:
      - major
      - minor
      - patch
  sort-order:
    description: Sort order for candidate versions within scope (asc|desc)
    required: false
    default: asc
    type: choice
    options:
      - asc
      - desc
  github-token:
    description: GitHub token with at least read access (defaults to workflow GITHUB_TOKEN)
    required: false
    default: ${{ github.token }}
  docker-username:
    description: Docker Hub username (optional for authenticated lookups)
    required: false
  docker-password:
    description: Docker Hub password (optional for authenticated lookups)
    required: false
  log-level:
    description: Level of logging verbosity (INFO, DEBUG, WARNING, ERROR)
    required: false
    default: INFO

outputs:
  updated-components:
    description: JSON array with updated component versions
    value: ${{ steps.update.outputs.updated-components }}

runs:
  using: composite
  steps:
    - name: Validate input JSON
      shell: bash
      run: |
        set -euo pipefail
        echo "Validating input JSON structure..."
        printf '%s' '${{ inputs.components }}' | python - <<'PY'
import json, sys
raw = sys.stdin.read()
try:
    data = json.loads(raw)
except Exception as e:  # noqa
    raise SystemExit(f"Invalid JSON for 'components': {e}")
if not isinstance(data, list):
    raise SystemExit("'components' must be a JSON array")
for i, item in enumerate(data):
    if not isinstance(item, dict) or 'name' not in item or 'version' not in item:
        raise SystemExit(f"Item {i} invalid: each entry needs 'name' and 'version'")
print(f"âœ“ Successfully validated {len(data)} components")
PY

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: ${{ github.action_path }}/requirements.txt

    - name: Create requirements file
      shell: bash
      run: |
        cat > "${GITHUB_ACTION_PATH}/requirements.txt" << 'EOF'
requests>=2.31.0,<3.0.0
python-dotenv>=1.0.0,<2.0.0
EOF

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "Installing dependencies..."
        python -m pip install --disable-pip-version-check --no-cache-dir -r "${GITHUB_ACTION_PATH}/requirements.txt"

    - id: update
      name: Run update script
      shell: bash
      env:
        FILTER_SCOPE: ${{ inputs.filter-scope }}
        SORT_ORDER: ${{ inputs.sort-order }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        DOCKER_USERNAME: ${{ inputs.docker-username }}
        DOCKER_PASSWORD: ${{ inputs.docker-password }}
        COMPONENTS_JSON: ${{ inputs.components }}
        PYTHONUNBUFFERED: "1"
        LOG_LEVEL: ${{ inputs.log-level }}
      run: |
        set -euo pipefail
        echo "Running component update script..."
        python "${GITHUB_ACTION_PATH}/update-eureka-components.py"
        # Ensure an output key exists even if script wrote nothing
        grep -q '^updated-components=' "$GITHUB_OUTPUT" || echo 'updated-components=[]' >> "$GITHUB_OUTPUT"
        echo "Component update completed"

branding:
  icon: refresh-cw
  color: blue
