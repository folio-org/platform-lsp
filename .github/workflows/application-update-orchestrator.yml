name: Application Update Orchestrator

run-name: Platform applications update on ${{ inputs.platform_branch }}

on:
  workflow_dispatch:
    inputs:
      platform_branch:
        description: 'Platform branch to get application list from (e.g., snapshot, R1-2025)'
        required: true
        type: string
      dry_run:
        description: 'Perform dry run without making changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: app-update-orchestrator-${{ inputs.platform_branch }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-and-approve:
    uses: folio-org/kitfox-github/.github/workflows/validate-and-approve.yml@master
    with:
      environment: 'Eureka CI'
      organization: 'folio-org'
      team: 'kitfox'
    secrets: inherit

  get-applications:
    name: Extract Application List
    runs-on: ubuntu-latest
    needs: validate-and-approve
    outputs:
      applications: ${{ steps.extract-applications.outputs.applications }}
      application_count: ${{ steps.extract-applications.outputs.application_count }}
    steps:
      - name: Checkout Platform Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.platform_branch }}
          fetch-depth: 0

      - name: Extract Applications from Platform Descriptor
        id: extract-applications
        env:
          FILE: "platform-descriptor.json"
          PLATFORM_BRANCH: ${{ inputs.platform_branch }}
        run: |
          set -eo pipefail

          if [ ! -f "$FILE" ]; then
            echo "::error::$FILE not found in the $PLATFORM_BRANCH branch"
            exit 1
          fi

          existing_apps=$(jq -c '
            [.applications.required[]?, .applications.optional[]?]
            | map(select(.name | startswith("app-"))
            | .name)
            | sort
            | unique
          ' "$FILE")

          existing_count=$(jq -r 'length' <<<"$existing_apps")
          if ! [[ "$existing_count" -gt 0 ]]; then
            echo "::error::Could not find any applications in $FILE, or the file is malformed."
            exit 1
          fi

          echo "::notice::Platform descriptor verified. Found $existing_count application(s) in $PLATFORM_BRANCH"
          jq -r '.[]' <<<"$existing_apps" | sed 's/^/  - /'

          echo "applications=$existing_apps" >> "$GITHUB_OUTPUT"
          echo "application_count=$existing_count" >> "$GITHUB_OUTPUT"
