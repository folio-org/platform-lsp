name: Update Snapshot Applications Orchestrator

on:
  workflow_dispatch:
    inputs:
      descriptor_build_offset:
        description: 'Offset to apply to application artifact version'
        required: false
        type: string
        default: '100100000000000'
      rely_on_FAR:
        description: 'Whether to rely on FAR for application descriptor dependencies'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Perform dry run without making changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  validate-actor:
    name: Validate Actor
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.validate-actor.outputs.authorized }}
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}

      - name: Validate Actor
        id: validate-actor
        uses: folio-org/kitfox-github/.github/actions/validate-team-membership@master
        with:
          username: ${{ github.actor }}
          organization: 'folio-org'
          team: 'kitfox'
          token: ${{ steps.app-token.outputs.token }}

  approve-run:
    name: Approve Run
    needs: validate-actor
    runs-on: ubuntu-latest
    environment: Eureka CI
    if: needs.validate-actor.outputs.authorized == 'false'
    steps:
      - name: Run approvement
        run: |
          echo "::notice::This run was approved by $(
            gh api \
              /repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/approvals \
              --jq \
                '.[] 
                | select(.environments[]?.name == "Eureka CI") 
                | .user.login')"

  get-applications:
    name: Extract Application List
    runs-on: ubuntu-latest
    needs: [ validate-actor, approve-run ]
    if: always() && (needs.validate-actor.outputs.authorized == 'true' || needs.approve-run.result == 'success')
    outputs:
      applications: ${{ steps.extract-applications.outputs.applications }}
      application_count: ${{ steps.extract-applications.outputs.application_count }}
    steps:
      - name: Checkout Platform Repository
        uses: actions/checkout@v4
        with:
          ref: snapshot
          fetch-depth: 0

      - name: Extract Existing Applications
        id: extract-applications
        env:
            FILE: "platform-descriptor.json"
        run: |
          set -eo pipefail

          if [ ! -f "$FILE" ]; then
            echo "::error::$FILE not found in the snapshot branch"
            exit 1
          fi

          existing_apps=$(jq -c '
            [.applications.required[]?, .applications.optional[]?]
            | map(select(.name | startswith("app-")) 
            | .name)
            | sort 
            | unique
          ' "$FILE")
          
          existing_count=$(jq -r 'length' <<<"$existing_apps")
          if ! [[ "$existing_count" -gt 0 ]]; then
            echo "::error::Could not find any applications in $FILE, or the file is malformed."
            exit 1
          fi
          
          echo "::notice::Descriptor verified. $FILE found with $existing_count existing app(s)"
          jq -r '.[]' <<<"$existing_apps" | sed 's/^/  - /'
          
          echo "applications=$(jq -c '.[0:2]' <<<$existing_apps)" >> "$GITHUB_OUTPUT" # TODO: Switch back to the $existing_apps
          echo "application_count=$(jq -r 'length' <<<$limited_apps)" >> "$GITHUB_OUTPUT" # TODO: Switch back to the $limited_apps

      - name: Upload Platform Descriptor
        if: ${{ !inputs.rely_on_FAR }}
        uses: actions/upload-artifact@v4
        with:
          name: platform-descriptor
          path: platform-descriptor.json
          retention-days: 1

  update-applications:
    name: Update ${{ matrix.application }}
    needs: get-applications
    if: always() && needs.get-applications.result == 'success'
    strategy:
      matrix:
        application: ${{ fromJson(needs.get-applications.outputs.applications) }}
      fail-fast: false
      max-parallel: 10
    uses: folio-org/kitfox-github/.github/workflows/app-update.yml@RANCHER-2321-test # TODO: Switch back to master before merging
    with:
      app_name: ${{ matrix.application }}
      repo: folio-org/${{ matrix.application }}
      workflow_run_number: ${{ github.run_number }}
      descriptor_build_offset: ${{ inputs.descriptor_build_offset }}
      rely_on_FAR: ${{ inputs.rely_on_FAR }}
      dry_run: ${{ inputs.dry_run }}
      use_github_app: true
    secrets: inherit

  collect-results:
    name: Collect Application Results
    needs: [get-applications, update-applications]
    runs-on: ubuntu-latest
    if: always() && needs.update-applications.result != 'skipped' && !inputs.dry_run
    outputs:
      failed_apps: ${{ steps.gather-failures.outputs.failed_apps }}
      failed_apps_reason: ${{ steps.gather-failures.outputs.failed_apps_reason }}
      success_count: ${{ steps.gather-failures.outputs.success_count }}
      failure_count: ${{ steps.gather-failures.outputs.failure_count }}
      updated_count: ${{ steps.gather-failures.outputs.updated_count }}
      updated_applications: ${{ steps.gather-failures.outputs.updated_applications }}
    steps:
      - name: Download All Application Results
        uses: actions/download-artifact@v4
        with:
          pattern: "result-*"
          path: /tmp/all-results
          merge-multiple: true

      - name: Gather Application Results
        id: gather-failures
        run: |
          set -eo pipefail
          
          echo "::notice::Analyzing application results"

          all=$(jq -s '.' /tmp/all-results/*.json)

          success_count=$(jq '[.[] | select(.status=="success")] | length' <<<"$all")
          failure_count=$(jq '[.[] | select(.status!="success")] | length' <<<"$all")
          updated_count=$(jq '[.[] | select(.updated==true)] | length' <<<"$all")
          failed_apps=$(jq -r '[.[] | select(.status!="success") | .application] | join(", ")' <<<"$all")
          failed_apps_reason=$(jq -r '
            [.[] | select(.status!="success") | "\(.application): \(.failure_reason // "unknown")"]
            | join("\n")
          ' <<<"$all")
          
          updated_applications=$(jq -r --arg base "${GITHUB_SERVER_URL}" --arg owner "${{ github.repository_owner }}" '
            [.[] 
              | select(.updated==true) 
              | "\(.application) (\(.updated_cnt))>" 
            ] 
            | join("\n")
          ' <<<"$all")

          echo "::notice::updated_count: $updated_count"
          
          # <\($base)/\($owner)/\(.application)/commit/\(.commit_sha)|
          
          echo "::notice::updated_applications: $updated_applications" #TODO: Remove this line after debugging
          
          echo "::notice::Results Summary - Success: $success_count, Failures: $failure_count"
          
          echo "failed_apps=$failed_apps" >> "$GITHUB_OUTPUT"
          echo "success_count=$success_count" >> "$GITHUB_OUTPUT"
          echo "failure_count=$failure_count" >> "$GITHUB_OUTPUT" 
          echo "updated_count=$updated_count" >> "$GITHUB_OUTPUT"
          {
            echo "failed_apps_reason<<EOF"
            printf '%s\n' "$failed_apps_reason"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          {
            echo "updated_applications<<EOF"
            printf '%s\n' "$updated_applications"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  slack_notification:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [get-applications, update-applications, collect-results]
    if: always() && needs.collect-results.result == 'success' && !inputs.dry_run
    env:
      IS_SUCCESS: ${{ needs.update-applications.result == 'success' && 'true' || 'false' }}
    steps:
      - name: Prepare Multiline Strings
        id: prepare-multiline
        env:
          REASONS: "${{ needs.collect-results.outputs.failed_apps_reason }}"
          UPDATED: "${{ needs.collect-results.outputs.updated_applications }}"
        run: |
          set -eo pipefail
          
          echo "::notice::Build fail reasons info string"
          echo "failed_reasons<<EOF"$'\n'"$REASONS"$'\n'EOF >> "$GITHUB_OUTPUT"

          echo "::notice::Build updated applications info string"
          echo "updated_applications<<EOF"$'\n'"$UPDATED"$'\n'EOF >> "$GITHUB_OUTPUT"

      - name: Send SUCCESS Slack Notification
        if: env.IS_SUCCESS == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: true
          payload: |
            channel: "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}"
            text: "Snapshot Applications Update SUCCESS"            
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: "*Platform Snapshot Applications Update SUCCESS <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
            attachments:
              - color: "good"
                fields:
                  - title: "Updated Applications"
                    value: "${{ needs.collect-results.outputs.updated_count }}"
                    short: true
                  - title: "Total Applications"
                    value: "${{ needs.collect-results.outputs.success_count }}"
                    short: true
              - color: "good"
                mrkdwn_in: ["fields"]
                text: ${{ toJSON(steps.prepare-multiline.outputs.updated_applications) }}
                footer: "Eureka CI/CD"

      - name: Send FAILED Slack Notification
        if: env.IS_SUCCESS == 'false'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: true
          payload: |
            channel: "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}"
            text: "Snapshot Applications Update FAILED"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: "*Platform Snapshot Applications Update FAILED <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
            attachments:
              - color: "danger"
                fields:
                  - title: "Successfully Processed"
                    value: "${{ needs.collect-results.outputs.success_count }}"
                    short: true
                  - title: "Failed"
                    value: "${{ needs.collect-results.outputs.failure_count }}"
                    short: true
              - color: "danger"
                mrkdwn_in: ["fields"]
                title: "Reasons"
                text: ${{ toJSON(steps.prepare-multiline.outputs.failed_reasons) }}
                footer: "Eureka CI/CD"
